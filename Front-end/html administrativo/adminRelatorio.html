<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Executivo | Conetec</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="shortcut icon" type="image/etec" href="../images/icon.png">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (XLSX) para exportar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    /* Ajustes visuais adicionais para aparência "Power BI clássico" */
    body { background: linear-gradient(180deg,#f4f6f9 0%, #ffffff 100%); font-family: Inter, system-ui, Arial; color:#222; }
    .pb-wrap { max-width:1300px; margin:20px auto; padding:20px; }
    .pb-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
    .pb-title { font-size:20px; color:#a60000; font-weight:700; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .controls select, .controls input { padding:8px 10px; border-radius:6px; border:1px solid #d0d0d0; }
    .controls button { background:#a60000; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:700; }
    .table-actions { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
    .export-btn { background:#1f7a1f; color:#fff; padding:8px 10px; border-radius:6px; font-weight:700; border:none; cursor:pointer; }
    table.report-table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    table.report-table thead th { background:#a60000; color:#fff; padding:10px; text-align:center; }
    table.report-table td { padding:8px; text-align:center; border-top:1px solid #eee; font-size:13px; }
    .small-muted { font-size:12px; color:#666; }
    /* ensure modal-like detail keeps your styles */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div>
        <div class="pb-title">Dashboard Executivo — Conetec (Power BI style)</div>
        <div class="small-muted">Visão gerencial e exportável — admin</div>
      </div>

      <div class="controls">
        <select id="filterStatus"><option value="">Todos os Status</option><option value="Pendente">Pendente</option><option value="Em Andamento">Em Andamento</option><option value="Resolvido">Resolvido</option></select>
        <select id="filterTecnico"><option value="">Todos os Técnicos</option></select>
        <select id="filterSala"><option value="">Todas as Salas</option></select>
        <input id="dateFrom" type="date" />
        <input id="dateTo" type="date" />
        <button id="btnRefresh">Atualizar</button>
        <button id="btnExportAll" class="export-btn">Exportar tudo (Excel)</button>
        <button id="btnExportFiltered" class="export-btn">Exportar filtrado (Excel)</button>
      </div>
    </div>


  <div class="grid">
    <!-- Cards de Resumo -->
      <div class="card"><h3>Pendentes</h3><div class="value" id="count-pendentes">0</div></div>
      <div class="card"><h3>Em andamento</h3><div class="value" id="count-andamento">0</div></div>
      <div class="card"><h3>Resolvidos</h3><div class="value" id="count-resolvidos">0</div></div>
      <div class="card"><h3>Tempo Médio Geral (horas)</h3><div class="value" id="tempo-medio-geral">0</div></div>
  </div>

  <!-- Gráficos -->
  <div class="grid2">
    <div class="card2 chart-card">
      <h3>Tempo Médio por Técnico</h3>
      <canvas id="graficoTempoMedio"  height="200"></canvas>
    </div>

    <div class="card2 chart-card">
      <h3>Chamados por Técnico</h3>
      <canvas id="graficoChamadosPorTecnico" height="200"></canvas>
    </div>
 
    <div class="card2 chart-card">
      <h3>Chamados por Sala</h3>
      <canvas id="graficoChamadosPorSala" height="200"></canvas>
    </div>
    
    <div class="card2 chart-card">
      <h3>Chamados por Turno</h3>
      <canvas id="graficoChamadosPorTurno" height="200"></canvas>
    </div>

    <div class="card2 chart-card">
      <h3>Chamados por Dia</h3>
      <canvas id="graficoChamadosPorDia" height="200"></canvas>
    </div>
 
    <div class="card2 chart-card">
      <h3>Resolvidos por Dia</h3>
      <canvas id="graficoResolvidosPorDia" height="200"></canvas>
    </div>
    
 </div>

    <!-- Tabela detalhada (estilo histórico) -->
    <div style="margin-top:10px;">
      <div class="table-actions">
        <div class="small-muted">Tabela detalhada — use filtros acima para exportar o conjunto desejado</div>
        <button id="btnReloadTable" style="margin-left:auto;" class="delete-btn">Recarregar tabela</button>
      </div>

      <div style="overflow:auto; max-height:420px;">
        <table class="report-table" id="reportTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Título</th>
              <th>Usuário</th>
              <th>Categoria</th>
              <th>Prioridade</th>
              <th>Status</th>
              <th>Data Abertura</th>
              <th>Data Resolução</th>
            </tr>
          </thead>
          <tbody id="reportBody">
            <tr><td colspan="8" style="text-align:center;padding:18px;">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ====== Config ====== */
const API_BASE = "http://localhost:8000/api/dashboard";
const RELATORIO_ALL = "http://localhost:8000/api/dashboard/relatorio"; // deve retornar { totais, chamados }

/* ====== Util ====== */
function el(id) { return document.getElementById(id); }
async function getJson(url) {
  const res = await fetch(url, { headers: { "Content-Type":"application/json" } });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

/* ====== Charts (serão inicializados depois) ====== */
let chartSala, chartPrioridade, chartRanking, chartAbertosVsResolvidos, chartEvolucao;

/* ====== Inicialização de selects (técnicos / salas) ====== */
async function popularFiltros() {
  try {
    const porTecnico = await getJson(API_BASE + "/porTecnico");
    const selTec = el('filterTecnico');
    selTec.innerHTML = '<option value="">Todos os Técnicos</option>';
    (porTecnico || []).forEach(r => {
      const o = document.createElement('option'); o.value = r.tecnico; o.textContent = r.tecnico; selTec.appendChild(o);
    });
  } catch(e){ console.warn('porTecnico', e.message); }

  try {
    const porSala = await getJson(API_BASE + "/porSala");
    const selSala = el('filterSala');
    selSala.innerHTML = '<option value="">Todas as Salas</option>';
    (porSala || []).forEach(r => {
      const o = document.createElement('option'); o.value = r.sala; o.textContent = r.sala; selSala.appendChild(o);
    });
  } catch(e){ console.warn('porSala', e.message); }
}

async function fetchJson(url) {
  const res = await fetch(url);
  if (!res.ok) {
    const txt = await res.text().catch(() => '[sem corpo]');
    throw new Error(`HTTP ${res.status} ${res.statusText} - ${txt}`);
  }
  return res.json();
}

async function carregarDashboard() {
  try {

    const data = await fetchJson("http://localhost:8000/api/dashboard/");

    // Segurança: defaults
    const cards = data.cards || { pendentes: 0, andamento: 0, resolvidos: 0 };
    const tempoMedio = data.tempoMedio ?? 0;
    const ultimos = Array.isArray(data.ultimos) ? data.ultimos : [];

    // === Cards ===
    document.getElementById("count-pendentes").innerText = cards.pendentes ?? 0;
    document.getElementById("count-andamento").innerText = cards.andamento ?? 0;
    document.getElementById("count-resolvidos").innerText = cards.resolvidos ?? 0;
    document.getElementById("tempo-medio-geral").innerText = String(tempoMedio);

    // === Últimos chamados (tabela) ===
    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";

    const chamadosAtivos = ultimos.filter(chamado =>
      chamado && (chamado.status === "Pendente" || chamado.status === "Em Andamento")
    );

    if (chamadosAtivos.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Nenhum chamado pendente ou em andamento</td></tr>`;
    } else {
      chamadosAtivos.forEach(chamado => {
        // proteções contra undefined
        const id = chamado.id ?? '—';
        const titulo = chamado.titulo ?? '—';
        const usuario = chamado.usuario ?? '—';
        const categoria = chamado.categoria ?? '—';
        const status = chamado.status ?? '—';
        const dataAb = chamado.data_abertura ? new Date(chamado.data_abertura).toLocaleDateString("pt-BR") : '—';

        tbody.innerHTML += `
          <tr>
            <td>${id}</td>
            <td>${titulo}</td>
            <td>${usuario}</td>
            <td>${categoria}</td>
            <td class="${
              status === "Pendente" ? "status-pendente" :
              status === "Em Andamento" ? "status-andamento" :
              status === "Resolvido" ? "status-resolvido" : ""
            }">${status}</td>
            <td>${dataAb}</td>
          </tr>
        `;
      });
    }
  } catch (err) {
    console.error("Erro ao carregar dashboard (cards/ultimos):", err);
    const tbody = document.getElementById("table-body");
    if (tbody) tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#a00;">Erro ao carregar dados</td></tr>`;
  }
}

async function carregarGraficos() {
  try {
    // --- Chamados por Sala ---
    let salas = [];
    try { salas = await fetchJson("http://localhost:8000/api/dashboard/porSala"); }
    catch(e){ console.warn("porSala:", e.message); salas = []; }

    new Chart(document.getElementById("graficoChamadosPorSala"), {
      type: "bar",
      data: {
        labels: (salas || []).map(s => s.sala ?? '—'),
        datasets: [{
          label: "Chamados",
          data: (salas || []).map(s => s.total ?? 0),
          backgroundColor: "#3498db"
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // --- Chamados por Técnico ---
    let tecnicos = [];
    try { tecnicos = await fetchJson("http://localhost:8000/api/dashboard/porTecnico"); }
    catch(e){ console.warn("porTecnico:", e.message); tecnicos = []; }

    new Chart(document.getElementById("graficoChamadosPorTecnico"), {
      type: "pie",
      data: {
        labels: (tecnicos || []).map(t => t.tecnico ?? '—'),
        datasets: [{
          label: "Chamados",
          data: (tecnicos || []).map(t => t.total ?? 0),
          backgroundColor: ["#e67e22", "#3498db", "#27ae60", "#9b59b6", "#f1c40f"]
        }]
      },
      options: { responsive: true }
    });

    // --- Tempo Médio por Técnico ---
    let tempoMedio = [];
    try { tempoMedio = await fetchJson("http://localhost:8000/api/dashboard/tempoMedioTecnico"); }
    catch(e){ console.warn("tempoMedioTecnico:", e.message); tempoMedio = []; }

    new Chart(document.getElementById("graficoTempoMedio"), {
      type: "bar",
      data: {
        labels: (tempoMedio || []).map(t => t.tecnico ?? '—'),
        datasets: [{
          label: "Tempo Médio (min)",
          data: (tempoMedio || []).map(t => t.media ?? 0),
          backgroundColor: "#2ecc71"
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // --- Chamados por Dia ---
    let dias = [];
    try { dias = await fetchJson("http://localhost:8000/api/dashboard/porDia"); }
    catch(e){ console.warn("porDia:", e.message); dias = []; }

    new Chart(document.getElementById("graficoChamadosPorDia"), {
      type: "line",
      data: {
        labels: (dias || []).map(d => d.dia ? new Date(d.dia).toLocaleDateString("pt-BR") : '—'),
        datasets: [{
          label: "Chamados",
          data: (dias || []).map(d => d.total ?? 0),
          borderColor: "#2980b9",
          backgroundColor: "rgba(41, 128, 185, 0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    // --- Chamados Resolvidos por Dia ---
    let resolvidos = [];
    try { resolvidos = await fetchJson("http://localhost:8000/api/dashboard/resolvidosPorDia"); }
    catch(e){ console.warn("resolvidosPorDia:", e.message); resolvidos = []; }

    new Chart(document.getElementById("graficoResolvidosPorDia"), {
      type: "line",
      data: {
        labels: (resolvidos || []).map(d => d.dia ? new Date(d.dia).toLocaleDateString("pt-BR") : '—'),
        datasets: [{
          label: "Resolvidos",
          data: (resolvidos || []).map(d => d.total ?? 0),
          borderColor: "#27ae60",
          backgroundColor: "rgba(39, 174, 96, 0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    // --- Chamados por Turno ---
    let turnos = [];
    try { turnos = await fetchJson("http://localhost:8000/api/dashboard/porTurno"); }
    catch(e){ console.warn("porTurno:", e.message); turnos = []; }

    new Chart(document.getElementById("graficoChamadosPorTurno"), {
      type: "doughnut",
      data: {
        labels: (turnos || []).map(t => t.turno ?? '—'),
        datasets: [{
          label: "Chamados",
          data: (turnos || []).map(t => t.total ?? 0),
          backgroundColor: ["#f39c12", "#8e44ad", "#16a085"]
        }]
      },
      options: { responsive: true }
    });

    // --- Tempo Médio por Urgência ---
let urgencias = [];
try { urgencias = await fetchJson("http://localhost:8000/api/dashboard/tempoMedioUrgencia"); }
catch(e){ console.warn("tempoMedioUrgencia:", e.message); urgencias = []; }

new Chart(document.getElementById("graficoTempoMedioUrgencia"), {
  type: "bar",
  data: {
    labels: urgencias.map(u => u.urgencia ?? '—'),
    datasets: [{
      label: "Tempo Médio (horas)",
      data: urgencias.map(u => u.tempo_medio_horas ?? 0),
      backgroundColor: ["#e74c3c","#f39c12","#2ecc71"]
    }]
  },
  options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

// --- Percentual Dentro do Prazo ---
let prazo = { percentual_dentro_prazo: 0 };
try { prazo = await fetchJson("http://localhost:8000/api/dashboard/percentualDentroPrazo"); }
catch(e){ console.warn("percentualDentroPrazo:", e.message); }
document.getElementById("percentualPrazo").innerText = `${prazo.percentual_dentro_prazo ?? 0}%`;

// --- Ranking de Técnicos ---
let ranking = [];
try { ranking = await fetchJson("http://localhost:8000/api/dashboard/rankingTecnicos"); }
catch(e){ console.warn("rankingTecnicos:", e.message); ranking = []; }

new Chart(document.getElementById("graficoRankingTecnicos"), {
  type: "bar",
  data: {
    labels: ranking.map(r => r.tecnico ?? '—'),
    datasets: [{
      label: "Tempo Médio (h)",
      data: ranking.map(r => r.tempo_medio_horas ?? 0),
      backgroundColor: "#8e44ad"
    }]
  },
  options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

// --- Abertos vs Resolvidos (mês atual) ---
let abertosRes = [];
try { abertosRes = await fetchJson("http://localhost:8000/api/dashboard/abertosVsResolvidosMes"); }
catch(e){ console.warn("abertosVsResolvidosMes:", e.message); abertosRes = []; }

new Chart(document.getElementById("graficoAbertosResolvidos"), {
  type: "bar",
  data: {
    labels: abertosRes.map(a => a.mes ?? '—'),
    datasets: [
      { label: "Abertos", data: abertosRes.map(a => a.abertos ?? 0), backgroundColor: "#e74c3c" },
      { label: "Resolvidos", data: abertosRes.map(a => a.resolvidos ?? 0), backgroundColor: "#2ecc71" }
    ]
  },
  options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

// --- Evolução de Resolvidos ---
let evolucao = [];
try { evolucao = await fetchJson("http://localhost:8000/api/dashboard/evolucaoResolvidos"); }
catch(e){ console.warn("evolucaoResolvidos:", e.message); evolucao = []; }

new Chart(document.getElementById("graficoEvolucaoResolvidos"), {
  type: "line",
  data: {
    labels: evolucao.map(e => e.mes ?? '—'),
    datasets: [{
      label: "Resolvidos",
      data: evolucao.map(e => e.total ?? 0),
      borderColor: "#27ae60",
      backgroundColor: "rgba(39,174,96,0.2)",
      fill: true,
      tension: 0.3
    }]
  },
  options: { responsive: true }
});

// --- Chamados por Equipamento ---
let equipamentos = [];
try { equipamentos = await fetchJson("http://localhost:8000/api/dashboard/porEquipamento"); }
catch(e){ console.warn("porEquipamento:", e.message); equipamentos = []; }

new Chart(document.getElementById("graficoEquipamentos"), {
  type: "pie",
  data: {
    labels: equipamentos.map(e => e.equipamento ?? '—'),
    datasets: [{
      data: equipamentos.map(e => e.total ?? 0),
      backgroundColor: ["#1abc9c","#3498db","#9b59b6","#f1c40f","#e67e22","#e74c3c"]
    }]
  },
  options: { responsive: true }
});


  } catch (err) {
    console.error("Erro ao carregar gráficos (geral):", err);
  }
}

// inicialização
window.addEventListener('load', () => {
  carregarDashboard();
  carregarGraficos();
});

/* ====== Export to Excel (SheetJS) ====== */
function exportToExcel(data, filename = 'relatorio.xlsx') {
  // data: array of objects
  if (!Array.isArray(data)) data = [];
  // build worksheet rows
  const ws_data = [
    ["ID","Título","Usuário","Categoria","Prioridade","Status","Data Abertura","Data Resolução"]
  ];
  data.forEach(r => {
    ws_data.push([
      r.id ?? '',
      r.titulo ?? '',
      r.usuario || r.usuario_nome || '',
      r.categoria ?? '',
      r.urgencia ?? (r.prioridade || ''),
      r.status ?? '',
      r.data_abertura ?? r.created_at ?? '',
      r.prazo_resolucao ?? r.data_resolvido ?? ''
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Relatorio");
  XLSX.writeFile(wb, filename);
}

/* ====== Event handlers ====== */
el('btnRefresh').addEventListener('click', async () => {
  await popularFiltros();
  await carregarTudo();
});

el('btnReloadTable').addEventListener('click', () => buildTableFromData(cachedRelatorio || []));

el('btnExportAll').addEventListener('click', async () => {
  try {
    // baixar todo o relatorio (cachedRelatorio)
    if (!cachedRelatorio) await carregarTabela(true);
    exportToExcel(cachedRelatorio || [], 'relatorio_tudo.xlsx');
  } catch (err) { console.error('exportAll', err); alert('Erro ao exportar'); }
});

el('btnExportFiltered').addEventListener('click', () => {
  const filtered = (cachedRelatorio || []).filter(r => {
    // re-use same filter logic as buildTableFromData
    const statusFilter = el('filterStatus').value;
    const tecFilter = el('filterTecnico').value;
    const salaFilter = el('filterSala').value;
    const dateFrom = el('dateFrom').value ? new Date(el('dateFrom').value) : null;
    const dateTo = el('dateTo').value ? new Date(el('dateTo').value) : null;
    if (dateTo) dateTo.setHours(23,59,59,999);

    if (statusFilter && (r.status !== statusFilter)) return false;
    if (tecFilter && r.tecnico !== tecFilter && r.tecnico_responsavel_nome !== tecFilter && r.tecnico_nome !== tecFilter) return false;
    if (salaFilter && r.sala !== salaFilter && r.sala_nome !== salaFilter) return false;
    if (dateFrom || dateTo) {
      const d = new Date(r.data_abertura || r.created_at || r.data_criacao);
      if (dateFrom && d < dateFrom) return false;
      if (dateTo && d > dateTo) return false;
    }
    return true;
  });
  exportToExcel(filtered, 'relatorio_filtrado.xlsx');
});

/* ====== On load ====== */
window.addEventListener('load', async () => {
  await popularFiltros();
  await carregarTudo();
});
</script>
</body>
</html>
